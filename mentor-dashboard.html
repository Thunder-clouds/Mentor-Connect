<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mentor Connect — Mentor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f6fb; }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-backdrop.flex { display: flex; }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="min-h-screen flex">
        <!-- Sidebar (desktop) -->
        <aside class="hidden md:flex md:w-72 lg:w-80 bg-white/80 backdrop-blur border-r border-gray-200 flex-col p-6">
            <div class="flex items-center gap-3 mb-6">
                <a href="home.html" class="flex items-center gap-3">
                    <img src="https://placehold.co/56x56/3B82F6/FFFFFF?text=MC" alt="Logo" class="w-14 h-14 rounded-full shadow-sm" />
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">Mentor Connect</h1>
                        <p class="text-sm text-gray-500">Connect • Learn • Grow</p>
                    </div>
                </a>
            </div>
            <nav class="flex-1">
                <a href="home.html" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700 mb-1 block">Home</a>
                <a href="login.html" class="w-full text-left px-3 py-2 rounded-lg bg-gray-100 text-gray-800 font-semibold mb-1 block">Login</a>
                <a href="register.html" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700 mb-1 block">Register</a>
                <div class="mt-4 border-t pt-4">
                    <p class="text-xs font-semibold text-gray-500 mb-2">Dashboards</p>
                    <a href="student-dashboard.html" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700 mb-1 block">Student</a>
                    <a href="mentor-dashboard.html" class="w-full text-left px-3 py-2 rounded-lg bg-gray-100 text-gray-800 font-semibold block">Mentor</a>
                </div>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="flex-1 flex flex-col">
            <header class="flex items-center justify-between bg-white border-b border-gray-200 px-6 py-3 md:py-4">
                <div class="flex items-center gap-6">
                    <input type="search" placeholder="Search..." class="hidden md:block px-4 py-2 rounded-lg border w-96 focus:outline-none focus:ring-2 focus:ring-blue-300" />
                </div>
                <div class="flex items-center gap-4">
                    <button class="p-2 rounded-lg hover:bg-gray-100" title="Notifications"><i data-lucide="bell" class="w-5 h-5 text-gray-600"></i></button>
                    <button class="p-2 rounded-lg hover:bg-gray-100" title="Messages"><i data-lucide="mail" class="w-5 h-5 text-gray-600"></i></button>
                    <button id="logout-button" class="px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 font-semibold">Logout</button>
                </div>
            </header>
            <div id="app-container" class="p-6 overflow-auto">
                <section id="mentor-dashboard-view">
                    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6">
                        <div class="col-span-12 lg:col-span-8 space-y-6">
                            <div class="bg-white rounded-2xl p-6 shadow-sm">
                                <div class="flex items-center gap-4">
                                    <img id="mentor-avatar" src="https://placehold.co/88x88/E0E7FF/4F46E5?text=M" class="w-20 h-20 rounded-full" alt="Mentor Avatar" />
                                    <div>
                                        <h2 id="mentor-name" class="text-2xl font-bold text-gray-800">Loading...</h2>
                                        <p id="mentor-title" class="text-sm text-gray-500">Mentor</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 shadow-sm">
                                <h3 class="font-semibold text-gray-700 mb-4">New Student Requests</h3>
                                <div id="requests-container" class="space-y-4">
                                    <p class="text-gray-500">Loading requests...</p>
                                </div>
                            </div>

                             <div class="bg-white rounded-2xl p-6 shadow-sm">
                                <h3 class="font-semibold text-gray-700 mb-4">Upcoming Meetings</h3>
                                <div id="upcoming-meetings-container" class="space-y-3">
                                   <p class="text-gray-500">No upcoming meetings scheduled.</p>
                                </div>
                            </div>

                        </div>
                        <aside class="col-span-12 lg:col-span-4 space-y-6">
                            <div class="bg-white rounded-2xl p-6 shadow-sm">
                                <h3 class="font-semibold text-gray-700 mb-4">My Mentees</h3>
                                <div id="mentees-container" class="space-y-4">
                                    <p class="text-gray-500">No active mentees yet.</p>
                                </div>
                            </div>
                        </aside>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scheduling Modal -->
    <div id="scheduling-modal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Schedule First Meeting</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Confirm the details for your first meeting with <b id="modal-student-name">Student</b>.</p>
            <form id="schedule-form">
                <div class="space-y-4">
                    <div>
                        <label for="meeting-datetime" class="block text-sm font-medium text-gray-700">Date and Time</label>
                        <input type="datetime-local" id="meeting-datetime" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="meeting-link" class="block text-sm font-medium text-gray-700">Meeting Link (Google Meet)</label>
                        <input type="url" id="meeting-link" value="https://meet.google.com/new" class="mt-1 w-full p-2 border rounded-md bg-gray-50" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-schedule-btn" class="px-4 py-2 rounded-md bg-gray-100 text-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">Schedule & Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDYQpNxmBE77NrxeQ0UB8THc7nkrZorMsc",
            authDomain: "mentor-connect-d11a0.firebaseapp.com",
            projectId: "mentor-connect-d11a0",
            storageBucket: "mentor-connect-d11a0.appspot.com",
            messagingSenderId: "729699493531",
            appId: "1:729699493531:web:ee8462c56452280ef6083e"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // Check if lucide is available before creating icons
            if (window.lucide) {
                lucide.createIcons();
            }

            const mentorNameEl = document.getElementById('mentor-name');
            const mentorTitleEl = document.getElementById('mentor-title');
            const mentorAvatarEl = document.getElementById('mentor-avatar');
            const logoutButton = document.getElementById('logout-button');
            const requestsContainer = document.getElementById('requests-container');
            const menteesContainer = document.getElementById('mentees-container');
            const meetingsContainer = document.getElementById('upcoming-meetings-container');
            
            const modal = document.getElementById('scheduling-modal');
            const scheduleForm = document.getElementById('schedule-form');
            const modalStudentName = document.getElementById('modal-student-name');
            let currentRequestId = null;
            let currentRequestData = null;

            let currentMentorId = null;

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentMentorId = user.uid;
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists && doc.data().role === 'mentor') {
                            const mentorProfileRef = db.collection('mentors').doc(user.uid);
                            mentorProfileRef.get().then(profileDoc => {
                                if(profileDoc.exists) {
                                    const profile = profileDoc.data();
                                    mentorNameEl.textContent = profile.fullName || user.email;
                                    mentorTitleEl.textContent = profile.jobTitle || 'Mentor';
                                    const initials = (profile.fullName || 'M').charAt(0).toUpperCase();
                                    mentorAvatarEl.src = `https://placehold.co/88x88/E0E7FF/4F46E5?text=${initials}`;
                                }
                            });
                            listenForRequests(user.uid);
                            listenForMentees(user.uid);
                        } else {
                            window.location.href = 'login.html';
                        }
                    });
                } else {
                    window.location.href = 'login.html';
                }
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => window.location.href = 'index.html');
            });

            const listenForRequests = (mentorId) => {
                const query = db.collection('mentorshipRequests').where('mentorId', '==', mentorId).where('status', '==', 'pending');
                query.onSnapshot(async snapshot => {
                    if (snapshot.empty) {
                        requestsContainer.innerHTML = `<p class="text-sm text-gray-500">No new student requests.</p>`;
                        return;
                    }
                    
                    const requestPromises = snapshot.docs.map(doc => {
                        const request = { id: doc.id, ...doc.data() };
                        return db.collection('users').doc(request.studentId).get().then(userDoc => {
                           if (userDoc.exists) {
                               request.studentInfo = userDoc.data();
                           }
                           return request;
                        });
                    });

                    const requestsWithDetails = await Promise.all(requestPromises);
                    renderRequests(requestsWithDetails);

                }, err => console.error(err));
            };

            const renderRequests = (requests) => {
                requestsContainer.innerHTML = '';
                requests.forEach(req => {
                    const studentName = req.studentInfo ? req.studentInfo.fullName : 'A Student';
                    const card = `
                        <div class="border rounded-lg p-4 flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-gray-800">${studentName}</p>
                                <p class="text-sm text-gray-500">Wants to connect with you.</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-request-id="${req.id}" class="decline-btn px-3 py-1 rounded-md bg-gray-100 text-sm">Decline</button>
                                <button data-request-id="${req.id}" data-student-name="${studentName}" class="accept-btn px-3 py-1 rounded-md bg-blue-600 text-white text-sm">Accept</button>
                            </div>
                        </div>`;
                    requestsContainer.insertAdjacentHTML('beforeend', card);
                });
            };
            
            requestsContainer.addEventListener('click', e => {
                const target = e.target;
                const requestId = target.dataset.requestId;

                if (target.classList.contains('decline-btn')) {
                    db.collection('mentorshipRequests').doc(requestId).update({ status: 'declined' });
                }
                
                if (target.classList.contains('accept-btn')) {
                    currentRequestId = requestId;
                    modalStudentName.textContent = target.dataset.studentName;
                    modal.classList.add('flex');
                }
            });

            const closeModal = () => {
                modal.classList.remove('flex');
                scheduleForm.reset();
                currentRequestId = null;
                currentRequestData = null;
            };

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-schedule-btn').addEventListener('click', closeModal);

            scheduleForm.addEventListener('submit', e => {
                e.preventDefault();
                const meetingTime = document.getElementById('meeting-datetime').value;
                const meetingLink = document.getElementById('meeting-link').value;

                db.collection('mentorshipRequests').doc(currentRequestId).get().then(doc => {
                    const requestData = doc.data();

                    const newMentorship = {
                        studentId: requestData.studentId,
                        mentorId: requestData.mentorId,
                        status: 'ongoing',
                        progress: 0,
                        meetings: [{
                            scheduledAt: new Date(meetingTime),
                            link: meetingLink,
                            status: 'scheduled'
                        }],
                        startedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    db.collection('mentorships').add(newMentorship).then(() => {
                         db.collection('mentorshipRequests').doc(currentRequestId).update({ status: 'accepted' });
                         closeModal();
                    });
                });
            });

            const listenForMentees = (mentorId) => {
                 const query = db.collection('mentorships').where('mentorId', '==', mentorId).where('status', '==', 'ongoing');
                 query.onSnapshot(async snapshot => {
                    if (snapshot.empty) {
                        menteesContainer.innerHTML = `<p class="text-sm text-gray-500">No active mentees yet.</p>`;
                        meetingsContainer.innerHTML = `<p class="text-sm text-gray-500">No upcoming meetings scheduled.</p>`;
                        return;
                    }
                    const menteePromises = snapshot.docs.map(doc => {
                        const mentorship = {id: doc.id, ...doc.data()};
                         return db.collection('users').doc(mentorship.studentId).get().then(userDoc => {
                           if (userDoc.exists) {
                               mentorship.studentInfo = userDoc.data();
                           }
                           return mentorship;
                        });
                    });
                    const mentees = await Promise.all(menteePromises);
                    renderMentees(mentees);
                    renderMeetings(mentees);
                 });
            };
            
            const renderMentees = (mentees) => {
                menteesContainer.innerHTML = '';
                 mentees.forEach(mentee => {
                    const card = `
                    <div class="flex items-center gap-3">
                        <img src="https://placehold.co/40x40/FEF3C7/F59E0B?text=${(mentee.studentInfo.fullName || 'S').charAt(0)}" class="w-10 h-10 rounded-full" />
                        <div>
                            <p class="font-semibold text-gray-800 text-sm">${mentee.studentInfo.fullName}</p>
                            <p class="text-xs text-gray-500">Progress: ${mentee.progress}%</p>
                        </div>
                    </div>
                    `;
                    menteesContainer.insertAdjacentHTML('beforeend', card);
                 });
            };

            const renderMeetings = (mentees) => {
                meetingsContainer.innerHTML = '';
                const allMeetings = [];
                mentees.forEach(mentee => {
                    if (mentee.meetings && mentee.meetings.length > 0) {
                        mentee.meetings.forEach(meeting => {
                            if (meeting.status === 'scheduled') {
                                allMeetings.push({ ...meeting, studentName: mentee.studentInfo.fullName });
                            }
                        });
                    }
                });

                if (allMeetings.length === 0) {
                     meetingsContainer.innerHTML = `<p class="text-sm text-gray-500">No upcoming meetings scheduled.</p>`;
                     return;
                }
                
                allMeetings.sort((a,b) => a.scheduledAt.toDate() - b.scheduledAt.toDate());

                allMeetings.forEach(meeting => {
                    const date = meeting.scheduledAt.toDate();
                    const formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    const formattedTime = date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit'});
                    const card = `
                        <div class="flex items-center gap-4 border rounded-lg p-3 hover:bg-gray-50">
                           <div class="flex flex-col items-center justify-center bg-blue-50 p-2 rounded-md">
                                <span class="text-xs text-blue-700 font-semibold">${formattedDate.split(' ')[0]}</span>
                                <span class="text-lg text-blue-800 font-bold">${formattedDate.split(' ')[1]}</span>
                           </div>
                            <div>
                                <div class="font-medium text-gray-800">Meeting with ${meeting.studentName}</div>
                                <div class="text-sm text-gray-500">${formattedTime} - via Google Meet</div>
                            </div>
                            <a href="${meeting.link}" target="_blank" class="ml-auto px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200">Join</a>
                        </div>
                    `;
                    meetingsContainer.insertAdjacentHTML('beforeend', card);
                });
            };

        });
    </script>
</body>
</html>

